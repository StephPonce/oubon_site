<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Oubon x TikTok Integration Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #e8ecf4;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 40px 20px;
      border-bottom: 2px solid #2d3550;
      margin-bottom: 40px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #00f2ea 0%, #00d9ff 100%);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      font-weight: bold;
      color: #0a0e27;
    }

    .tiktok-logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, #00f2ea, #ff0050, #000);
      border-radius: 12px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00f2ea, #00d9ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      font-size: 1.1em;
      color: #8891aa;
      margin-bottom: 20px;
    }

    .badge {
      display: inline-block;
      background: rgba(0, 242, 234, 0.1);
      border: 1px solid #00f2ea;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9em;
      color: #00f2ea;
      font-weight: 600;
    }

    /* Status Bar */
    .status-bar {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid #2d3550;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.connected {
      background: #00f2ea;
      box-shadow: 0 0 20px #00f2ea;
    }

    .status-indicator.disconnected {
      background: #ff6b6b;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 1.1em;
      font-weight: 600;
    }

    /* Buttons */
    .btn {
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1em;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00f2ea, #00d9ff);
      color: #0a0e27;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 242, 234, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e8ecf4;
      border: 1px solid #2d3550;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ff5252);
      color: white;
    }

    /* Product Cards Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .product-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid #2d3550;
      border-radius: 20px;
      padding: 30px;
      transition: all 0.3s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
      border-color: #00f2ea;
      box-shadow: 0 10px 40px rgba(0, 242, 234, 0.2);
    }

    .product-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .product-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, rgba(0, 242, 234, 0.2), rgba(0, 217, 255, 0.2));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .product-card h3 {
      font-size: 1.3em;
      margin-bottom: 10px;
      color: #00f2ea;
    }

    .product-card p {
      color: #8891aa;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .feature-list {
      list-style: none;
      margin-bottom: 20px;
    }

    .feature-list li {
      padding: 8px 0;
      color: #b8c0d4;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feature-list li:before {
      content: "‚úì";
      color: #00f2ea;
      font-weight: bold;
      font-size: 1.2em;
    }

    /* Demo Sections */
    .demo-section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid #2d3550;
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
    }

    .demo-section.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #2d3550;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .section-title h2 {
      font-size: 1.8em;
      color: #00f2ea;
    }

    .section-badge {
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .badge-active {
      background: rgba(0, 242, 234, 0.2);
      color: #00f2ea;
    }

    .badge-locked {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }

    /* Profile Display */
    .profile-display {
      display: flex;
      align-items: center;
      gap: 25px;
      padding: 25px;
      background: rgba(0, 242, 234, 0.05);
      border: 1px solid rgba(0, 242, 234, 0.2);
      border-radius: 15px;
      margin-bottom: 25px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #00f2ea;
    }

    .profile-info h3 {
      font-size: 1.5em;
      margin-bottom: 8px;
    }

    .profile-stats {
      display: flex;
      gap: 25px;
      margin-top: 10px;
    }

    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-value {
      font-size: 1.3em;
      font-weight: bold;
      color: #00f2ea;
    }

    .stat-label {
      font-size: 0.9em;
      color: #8891aa;
    }

    /* Video Grid */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .video-card {
      aspect-ratio: 9/16;
      background: #1a1f3a;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .video-card:hover {
      transform: scale(1.05);
    }

    .video-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: white;
    }

    .video-title {
      font-size: 0.9em;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .video-stats {
      font-size: 0.8em;
      opacity: 0.8;
    }

    /* Product Share Card */
    .share-product-card {
      display: flex;
      gap: 20px;
      padding: 25px;
      background: rgba(0, 242, 234, 0.05);
      border: 1px solid rgba(0, 242, 234, 0.2);
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .product-image {
      width: 150px;
      height: 150px;
      border-radius: 12px;
      object-fit: cover;
    }

    .product-details {
      flex: 1;
    }

    .product-details h4 {
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .product-price {
      font-size: 1.5em;
      color: #00f2ea;
      font-weight: bold;
      margin-bottom: 15px;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed #2d3550;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #00f2ea;
      background: rgba(0, 242, 234, 0.05);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #b8c0d4;
      font-weight: 600;
    }

    .form-control {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #2d3550;
      border-radius: 10px;
      color: #e8ecf4;
      font-size: 1em;
    }

    .form-control:focus {
      outline: none;
      border-color: #00f2ea;
      background: rgba(255, 255, 255, 0.08);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 40px 20px;
      border-top: 2px solid #2d3550;
      margin-top: 60px;
      color: #8891aa;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
    }

    .footer-links a {
      color: #00f2ea;
      text-decoration: none;
      transition: opacity 0.3s;
    }

    .footer-links a:hover {
      opacity: 0.7;
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #00f2ea;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.8em; }
      .products-grid { grid-template-columns: 1fr; }
      .status-bar { flex-direction: column; text-align: center; }
      .profile-display { flex-direction: column; text-align: center; }
      .share-product-card { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo-section">
        <div class="logo">O</div>
        <span style="font-size: 2em; opacity: 0.5;">√ó</span>
        <div class="tiktok-logo"></div>
      </div>
      <h1>Oubon √ó TikTok Integration Demo</h1>
      <p class="subtitle">Complete end-to-end demonstration of all TikTok API products and scopes</p>
      <div class="badge">üîí SANDBOX MODE</div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="connection-status">
        <div class="status-indicator disconnected" id="statusIndicator"></div>
        <div>
          <div class="status-text" id="statusText">Not Connected</div>
          <div style="font-size: 0.9em; color: #8891aa; margin-top: 5px;" id="statusDetails">
            Connect with TikTok to enable all features
          </div>
        </div>
      </div>
      <div>
        <button class="btn btn-primary" id="connectBtn" onclick="initiateLogin()">
          üîó Connect with TikTok
        </button>
        <button class="btn btn-danger hidden" id="disconnectBtn" onclick="disconnect()">
          ‚ö†Ô∏è Disconnect
        </button>
      </div>
    </div>

    <!-- Overview Cards -->
    <div class="products-grid">
      <div class="product-card">
        <div class="product-header">
          <div class="product-icon">üîê</div>
          <div>
            <h3>Login Kit</h3>
            <span class="badge-active section-badge">OAuth 2.0</span>
          </div>
        </div>
        <p>Secure authentication flow allowing users to connect their TikTok account</p>
        <ul class="feature-list">
          <li>User authorization</li>
          <li>Token management</li>
          <li>Profile access</li>
        </ul>
      </div>

      <div class="product-card">
        <div class="product-header">
          <div class="product-icon">üë§</div>
          <div>
            <h3>Display API</h3>
            <span class="badge-active section-badge">Profile & Videos</span>
          </div>
        </div>
        <p>Fetch and display user profile information and recent TikTok videos</p>
        <ul class="feature-list">
          <li>Profile information</li>
          <li>Video listing</li>
          <li>Engagement stats</li>
        </ul>
      </div>

      <div class="product-card">
        <div class="product-header">
          <div class="product-icon">üîó</div>
          <div>
            <h3>Share Kit</h3>
            <span class="badge-active section-badge">Product Sharing</span>
          </div>
        </div>
        <p>Enable users to share product content directly to TikTok with captions</p>
        <ul class="feature-list">
          <li>Product previews</li>
          <li>Draft creation</li>
          <li>Team collaboration</li>
        </ul>
      </div>

      <div class="product-card">
        <div class="product-header">
          <div class="product-icon">üìπ</div>
          <div>
            <h3>Content Posting API</h3>
            <span class="badge-active section-badge">Video Upload</span>
          </div>
        </div>
        <p>Upload short-form videos directly to user's TikTok account with metadata</p>
        <ul class="feature-list">
          <li>Direct video upload</li>
          <li>Privacy controls</li>
          <li>Caption & hashtags</li>
        </ul>
      </div>
    </div>

    <!-- Section 1: Login Kit (Always visible) -->
    <div class="demo-section" id="loginSection">
      <div class="section-header">
        <div class="section-title">
          <h2>üîê Login Kit</h2>
          <span class="badge-active section-badge">STEP 1</span>
        </div>
      </div>
      <p style="margin-bottom: 25px; color: #b8c0d4;">
        Authenticate with TikTok using OAuth 2.0 to enable all API features. In sandbox mode,
        only users added as "Target Users" in your TikTok Developer Portal can connect.
      </p>
      <div style="display: flex; gap: 15px; align-items: center;">
        <button class="btn btn-primary" onclick="initiateLogin()">
          üöÄ Start OAuth Flow
        </button>
        <span style="color: #8891aa; font-size: 0.9em;">
          Scopes: user.info.basic, user.info.profile, video.list, video.upload
        </span>
      </div>
    </div>

    <!-- Section 2: Display API -->
    <div class="demo-section disabled" id="displaySection">
      <div class="section-header">
        <div class="section-title">
          <h2>üë§ Display API</h2>
          <span class="badge-locked section-badge" id="displayBadge">LOCKED</span>
        </div>
        <button class="btn btn-secondary hidden" id="refreshProfileBtn" onclick="fetchUserProfile()">
          üîÑ Refresh Profile
        </button>
      </div>

      <p style="margin-bottom: 25px; color: #b8c0d4;">
        View authenticated user's TikTok profile information and recent videos.
      </p>

      <!-- Profile Display -->
      <div id="profileContainer" class="hidden">
        <div class="profile-display">
          <img id="profileAvatar" class="profile-avatar" src="" alt="Profile">
          <div class="profile-info">
            <h3 id="profileName">-</h3>
            <p style="color: #8891aa;" id="profileHandle">@-</p>
            <div class="profile-stats">
              <div class="stat">
                <span class="stat-value" id="followerCount">-</span>
                <span class="stat-label">Followers</span>
              </div>
              <div class="stat">
                <span class="stat-value" id="followingCount">-</span>
                <span class="stat-label">Following</span>
              </div>
              <div class="stat">
                <span class="stat-value" id="videoCount">-</span>
                <span class="stat-label">Videos</span>
              </div>
              <div class="stat">
                <span class="stat-value" id="likeCount">-</span>
                <span class="stat-label">Likes</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Videos -->
        <h3 style="margin-bottom: 15px; color: #00f2ea;">üìπ Recent Videos</h3>
        <div class="video-grid" id="videoGrid">
          <!-- Videos will be populated here -->
        </div>
      </div>
    </div>

    <!-- Section 3: Share Kit -->
    <div class="demo-section disabled" id="shareSection">
      <div class="section-header">
        <div class="section-title">
          <h2>üîó Share Kit</h2>
          <span class="badge-locked section-badge" id="shareBadge">LOCKED</span>
        </div>
      </div>

      <p style="margin-bottom: 25px; color: #b8c0d4;">
        Share Oubon Shop products directly to TikTok with customized captions and hashtags.
      </p>

      <!-- Sample Product -->
      <div class="share-product-card">
        <img class="product-image" src="https://via.placeholder.com/150" alt="Smart LED Bulb">
        <div class="product-details">
          <h4>Smart LED Light Bulb - RGB Color Changing</h4>
          <div class="product-price">$29.99</div>
          <p style="color: #8891aa; margin-bottom: 15px;">
            WiFi enabled smart bulb with 16 million colors, voice control compatible,
            and energy efficient LED technology. Perfect for modern smart homes.
          </p>
          <button class="btn btn-primary" onclick="shareToTikTok()">
            ‚ú® Share to TikTok
          </button>
        </div>
      </div>

      <div style="padding: 15px; background: rgba(0,242,234,0.05); border-left: 3px solid #00f2ea; border-radius: 8px; color: #b8c0d4;">
        <strong style="color: #00f2ea;">Demo Flow:</strong> This would open TikTok's share interface
        allowing the user to create a post with the product information and custom caption.
      </div>
    </div>

    <!-- Section 4: Content Posting API -->
    <div class="demo-section disabled" id="postingSection">
      <div class="section-header">
        <div class="section-title">
          <h2>üìπ Content Posting API</h2>
          <span class="badge-locked section-badge" id="postingBadge">LOCKED</span>
        </div>
      </div>

      <p style="margin-bottom: 25px; color: #b8c0d4;">
        Upload videos directly to the connected TikTok account. In sandbox mode, all posts
        are automatically set to private visibility.
      </p>

      <form onsubmit="uploadVideo(event)">
        <div class="upload-area" onclick="document.getElementById('videoFile').click()">
          <div class="upload-icon">üì§</div>
          <h3 style="margin-bottom: 10px;">Click to select video</h3>
          <p style="color: #8891aa;">Supports MP4, MOV, AVI (Max 50MB)</p>
          <input type="file" id="videoFile" accept="video/*" class="hidden" onchange="handleFileSelect(event)">
        </div>

        <div id="selectedFile" class="hidden" style="padding: 15px; background: rgba(0,242,234,0.05); border-radius: 10px; margin-bottom: 20px;">
          <strong style="color: #00f2ea;">Selected:</strong> <span id="fileName"></span>
          (<span id="fileSize"></span>)
        </div>

        <div class="form-group">
          <label for="videoTitle">Video Caption *</label>
          <textarea class="form-control" id="videoTitle" placeholder="Add an engaging caption with #hashtags" required></textarea>
        </div>

        <div class="form-group">
          <label for="privacyLevel">Privacy Level</label>
          <select class="form-control" id="privacyLevel">
            <option value="SELF_ONLY">üîí Private (Sandbox Required)</option>
            <option value="MUTUAL_FOLLOW_FRIENDS" disabled>üë• Friends</option>
            <option value="PUBLIC_TO_EVERYONE" disabled>üåç Public (Production Only)</option>
          </select>
        </div>

        <div style="display: flex; gap: 15px;">
          <button type="submit" class="btn btn-primary">
            üöÄ Upload to TikTok
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetVideoForm()">
            ‚ùå Reset
          </button>
        </div>
      </form>

      <div class="hidden" id="uploadProgress" style="margin-top: 20px; padding: 20px; background: rgba(0,242,234,0.05); border-radius: 10px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
          <div class="loading"></div>
          <span>Uploading video to TikTok...</span>
        </div>
        <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
          <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00f2ea, #00d9ff); transition: width 0.3s;"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div class="footer-links">
        <a href="https://policies.oubonshop.com/privacy.html">Privacy Policy</a>
        <a href="https://policies.oubonshop.com/terms.html">Terms of Service</a>
        <a href="mailto:support@oubonshop.com">support@oubonshop.com</a>
      </div>
      <div>¬© 2025 Ospra LLC ¬∑ All Rights Reserved</div>
      <div style="margin-top: 10px; font-size: 0.9em;">
        This is a sandbox demo for TikTok API integration review
      </div>
    </div>
  </div>

  <script>
    // Backend API configuration - ALL requests go through your FastAPI backend
    const API_BASE = 'https://blond-ross-ticket-duplicate.trycloudflare.com';

    // Debug: Intercept all fetch calls
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        console.log('üîç FETCH CALL:', args[0]);
        return originalFetch.apply(this, args).then(response => {
            return response.clone().json().then(data => {
                console.log('üì• RESPONSE:', data);
                return response;
            }).catch(() => response);
        });
    };

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      checkAuthState();
      loadBackendConfig();
    });

    // Load configuration from backend
    async function loadBackendConfig() {
      try {
        const response = await fetch(`${API_BASE}/api/tiktok/status`);
        const status = await response.json();

        console.log('TikTok Integration Status:', status);

        if (!status.enabled) {
          console.warn('‚ö†Ô∏è TikTok integration not fully configured');
          console.log('Set these environment variables:');
          console.log('  - TIKTOK_CLIENT_KEY');
          console.log('  - TIKTOK_CLIENT_SECRET');
          console.log('  - TIKTOK_REDIRECT_URI');
        }
      } catch (error) {
        console.error('Failed to load backend config:', error);
      }
    }

    // Check if user is authenticated
    async function checkAuthState() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const storedToken = localStorage.getItem('tiktok_access_token');

      if (code) {
        await handleOAuthCallback(code);
      } else if (storedToken) {
        updateUIForAuthenticated();
        fetchUserProfile();
      }
    }

    // Initiate TikTok OAuth login - Backend generates the URL
    async function initiateLogin() {
      try {
        // Call backend to generate OAuth URL with proper credentials
        const response = await fetch(`${API_BASE}/api/tiktok/auth/url`);
        const data = await response.json();

        if (data.authorization_url) {
          // Save state for CSRF protection
          localStorage.setItem('oauth_state', data.state);

          console.log('üîó Redirecting to TikTok OAuth...');
          console.log('Authorization URL:', data.authorization_url);

          // Redirect to TikTok authorization page
          window.location.href = data.authorization_url;
        } else {
          alert('‚ùå Failed to start OAuth flow\n\nError: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('OAuth initiation failed:', error);
        alert('‚ùå Error starting authentication\n\n' + error.message);
      }
    }

    // Handle OAuth callback
    async function handleOAuthCallback(code) {
      try {
        const response = await fetch(`${API_BASE}/api/tiktok/auth/callback?code=${code}`);
        const data = await response.json();

        if (data.access_token) {
          localStorage.setItem('tiktok_access_token', data.access_token);
          localStorage.setItem('tiktok_user_data', JSON.stringify(data.user_info || {}));

          window.history.replaceState({}, document.title, window.location.pathname);
          updateUIForAuthenticated();
          fetchUserProfile();
        } else {
          alert('‚ùå Authentication failed');
        }
      } catch (error) {
        console.error('Token exchange failed:', error);
        alert('‚ùå Authentication error');
      }
    }

    // Update UI when user is authenticated
    function updateUIForAuthenticated() {
      document.getElementById('statusIndicator').classList.remove('disconnected');
      document.getElementById('statusIndicator').classList.add('connected');
      document.getElementById('statusText').textContent = 'Connected';
      document.getElementById('statusDetails').textContent = 'All features unlocked';

      document.getElementById('connectBtn').classList.add('hidden');
      document.getElementById('disconnectBtn').classList.remove('hidden');

      enableSection('displaySection', 'displayBadge', 'ACTIVE');
      enableSection('shareSection', 'shareBadge', 'ACTIVE');
      enableSection('postingSection', 'postingBadge', 'ACTIVE');

      document.getElementById('refreshProfileBtn').classList.remove('hidden');
    }

    // Enable a demo section
    function enableSection(sectionId, badgeId, badgeText) {
      const section = document.getElementById(sectionId);
      const badge = document.getElementById(badgeId);

      section.classList.remove('disabled');
      badge.textContent = badgeText;
      badge.classList.remove('badge-locked');
      badge.classList.add('badge-active');
    }

    // Fetch and display user profile
    async function fetchUserProfile() {
      const token = localStorage.getItem('tiktok_access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/api/tiktok/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const profile = await response.json();

        if (profile) {
          displayProfile(profile);
          fetchUserVideos();
        }
      } catch (error) {
        console.error('Failed to fetch profile:', error);
      }
    }

    // Display user profile
    function displayProfile(profile) {
      document.getElementById('profileContainer').classList.remove('hidden');
      document.getElementById('profileAvatar').src = profile.avatar_url || 'https://via.placeholder.com/80';
      document.getElementById('profileName').textContent = profile.display_name || 'TikTok User';
      document.getElementById('followerCount').textContent = formatNumber(profile.follower_count || 0);
      document.getElementById('followingCount').textContent = formatNumber(profile.following_count || 0);
      document.getElementById('videoCount').textContent = formatNumber(profile.video_count || 0);
      document.getElementById('likeCount').textContent = formatNumber(profile.likes_count || 0);
    }

    // Fetch and display user videos
    async function fetchUserVideos() {
      const token = localStorage.getItem('tiktok_access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/api/tiktok/videos`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.videos) {
          displayVideos(data.videos);
        }
      } catch (error) {
        console.error('Failed to fetch videos:', error);
      }
    }

    // Display videos in grid
    function displayVideos(videos) {
      const videoGrid = document.getElementById('videoGrid');
      videoGrid.innerHTML = videos.map(video => `
        <div class="video-card" onclick="window.open('${video.share_url}', '_blank')">
          <img class="video-thumbnail" src="${video.cover_image_url}" alt="${video.title}">
          <div class="video-overlay">
            <div class="video-title">${video.title.substring(0, 40)}...</div>
            <div class="video-stats">üëÅÔ∏è ${formatNumber(video.view_count)} views</div>
          </div>
        </div>
      `).join('');
    }

    // Share product to TikTok
    function shareToTikTok() {
      alert('üîó Share Kit Demo\n\nIn production, this would open TikTok\'s share interface with pre-filled product information.');
    }

    // Handle video file selection
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      document.getElementById('selectedFile').classList.remove('hidden');
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
    }

    // Upload video to TikTok
    async function uploadVideo(event) {
      event.preventDefault();

      const file = document.getElementById('videoFile').files[0];
      const title = document.getElementById('videoTitle').value;
      const privacyLevel = document.getElementById('privacyLevel').value;
      const token = localStorage.getItem('tiktok_access_token');

      if (!file || !token) {
        alert('‚ö†Ô∏è Please select a video file and ensure you\'re authenticated');
        return;
      }

      const formData = new FormData();
      formData.append('video', file);
      formData.append('title', title);
      formData.append('privacy_level', privacyLevel);

      document.getElementById('uploadProgress').classList.remove('hidden');

      try {
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          document.getElementById('progressBar').style.width = progress + '%';
          if (progress >= 90) clearInterval(progressInterval);
        }, 300);

        const response = await fetch(`${API_BASE}/api/tiktok/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const result = await response.json();
        clearInterval(progressInterval);
        document.getElementById('progressBar').style.width = '100%';

        setTimeout(() => {
          document.getElementById('uploadProgress').classList.add('hidden');
          if (result.success) {
            alert('‚úÖ Video uploaded successfully!\n\nIn sandbox mode, the video is posted as private.');
          } else {
            alert('‚ùå Upload failed: ' + (result.error || 'Unknown error'));
          }
          resetVideoForm();
        }, 500);

      } catch (error) {
        console.error('Upload failed:', error);
        document.getElementById('uploadProgress').classList.add('hidden');
        alert('‚ùå Upload error');
      }
    }

    // Reset video upload form
    function resetVideoForm() {
      document.getElementById('videoFile').value = '';
      document.getElementById('videoTitle').value = '';
      document.getElementById('selectedFile').classList.add('hidden');
      document.getElementById('progressBar').style.width = '0%';
    }

    // Disconnect account
    function disconnect() {
      if (confirm('Are you sure you want to disconnect your TikTok account?')) {
        localStorage.removeItem('tiktok_access_token');
        localStorage.removeItem('tiktok_user_data');
        localStorage.removeItem('oauth_state');
        location.reload();
      }
    }

    // Utility functions
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatFileSize(bytes) {
      if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      if (bytes >= 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return bytes + ' bytes';
    }
  </script>
</body>
</html>
